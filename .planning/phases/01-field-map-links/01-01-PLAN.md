---
phase: 01-field-map-links
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/index.js]
autonomous: false
---

<objective>
Add field map links to both the subscribe page event list and the iCal calendar DESCRIPTION field.

Purpose: Users viewing the subscribe page can tap "Field map" to pull up the venue map. Calendar subscribers see the field map URL in the event description/notes in Apple Calendar, Google Calendar, or Outlook.
Output: `field_map_url` from `src/locations.csv` surfaced through `resolveLocation()` and rendered in both outputs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-field-map-links/1-CONTEXT.md
@src/index.js
@src/locations.csv
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plumb field_map_url through CSV parsing, location resolution, and iCal DESCRIPTION</name>
  <files>src/index.js</files>
  <action>
Three changes in src/index.js:

**1. `parseLocationsCSV` (around line 187):**
Change `fields.length >= 3` guard body from:
  `map[fields[0]] = { name: fields[1], address: fields[2] };`
To:
  `map[fields[0]] = { name: fields[1], address: fields[2], mapUrl: fields[3] || null };`

**2. `resolveLocation` (around line 210-214):**
Change the `if (complex)` return and the fallback return to include `mapUrl`:
  `return { field: raw, name: complex.name, address: complex.address, mapUrl: complex.mapUrl || null };`
  `return { field: raw, name: null, address: null, mapUrl: null };`

**3. `generateICal` DESCRIPTION building (around line 237-245):**
After the existing `if (loc.name) descParts.push(loc.name);` line, add:
  `if (loc.mapUrl) descParts.push(\`Field map: \${loc.mapUrl}\`);`

The DESCRIPTION in the iCal output should not use the iCal `URL:` property for the field map (as noted in CONTEXT.md, `URL:` is already used for the source page). The field map goes in DESCRIPTION only, as a plain text line. No changes needed to `handleTeamAPI` — it already returns `location: loc`, so `mapUrl` flows through to the API response automatically.
  </action>
  <verify>
Run `npm run dev` then:
`curl -s "http://localhost:8787/calendar/TEAM_ID" | grep "Field map:"`
Should print a line like `DESCRIPTION:Field 1 ... \nField map: https://...`
Also verify `/api/team/TEAM_ID` JSON response includes `location.mapUrl` for events at known venues (OSC, OP, CMSF, SSV, HSP, MAW).
  </verify>
  <done>
- `resolveLocation()` returns `mapUrl` (string or null)
- iCal DESCRIPTION includes `\nField map: {url}` when mapUrl is present
- `/api/team/{teamId}` response includes `location.mapUrl` for known prefixes
- Events at unknown field prefixes still work (mapUrl is null, no link added)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Field map link to subscribe page event rows</name>
  <files>src/index.js</files>
  <action>
In `renderSubscribePage`, find the client-side JS that builds event HTML (around line 824-829). The current `html +=` line is:

```javascript
html += '<div class="event-row">...' + (locLabel ? '<div class="meta">' + locLabel + '</div>' : '') + '</div></div>';
```

Add a field map link after the locLabel meta div. The link should:
- Only render when `loc && loc.mapUrl` is truthy
- Use plain anchor with `target="_blank"` and `rel="noopener"`
- Text: "Field map"
- Style: use existing `meta` class for consistent sizing/color, with the link color coming from `var(--accent)` via the global `a` style (no extra class needed)

Update the `html +=` line to include after the locLabel div:
```javascript
var mapLink = (loc && loc.mapUrl) ? '<div class="meta"><a href="' + esc(loc.mapUrl) + '" target="_blank" rel="noopener">Field map</a></div>' : '';
```
Then include `mapLink` in the `html +=` string after `locLabel`.

Note: `esc()` is already defined in the client-side JS as an HTML escape helper — use it on `loc.mapUrl`.
  </action>
  <verify>
Run `npm run dev`, visit `http://localhost:8787/subscribe/TEAM_ID` and wait for events to load. Inspect the DOM — events at known venues (OSC, OP, CMSF, SSV, HSP, MAW) should have a "Field map" anchor below the location line. Events at unknown venues should not.
  </verify>
  <done>
- "Field map" link appears below the location meta line for events at venues with a known map URL
- No link appears for events at unknown venues
- Link opens the correct URL (one of the 6 URLs from locations.csv)
- Link opens in new tab
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Field map links in subscribe page event list and iCal DESCRIPTION field</what-built>
  <how-to-verify>
    1. Run: `npm run dev`
    2. Visit: http://localhost:8787/subscribe/{your-team-id}
    3. Wait for events to load — check that events at known venues show a "Field map" link below the location line
    4. Click a "Field map" link — confirm it opens the correct map URL in a new tab
    5. In a separate tab, visit: http://localhost:8787/calendar/{your-team-id}
    6. Search the raw iCal output for "Field map:" — confirm it appears in DESCRIPTION for events at known venues, e.g.:
       `DESCRIPTION:Field OSC 1\nGARMIN Olathe Soccer Complex\nField map: https://www.heartlandsoccer.net/field-maps/olathe-soccer-complex/`
    7. Confirm events at unknown venues have no "Field map" text in DESCRIPTION and no link on the site
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run dev` starts without errors
- [ ] `/api/team/{teamId}` JSON includes `location.mapUrl` for known venue prefixes
- [ ] `/calendar/{teamId}` iCal DESCRIPTION includes `Field map:` line for known venues
- [ ] Subscribe page shows clickable "Field map" link for known venues only
- [ ] No regression: events at unknown venues still render correctly (no broken links, no null errors)
- [ ] Visual verify checkpoint approved
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Field map URL visible in subscribe page event list for all 6 known field prefixes
- Field map URL present in iCal DESCRIPTION for all 6 known field prefixes
- No link rendered for events at unknown venues
</success_criteria>

<output>
After completion, create `.planning/phases/01-field-map-links/01-01-SUMMARY.md`
</output>
