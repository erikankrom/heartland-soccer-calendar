---
phase: 05-add-cloudflare-website-analytics-tracking-script-to-website
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/index.js]
autonomous: true
user_setup:
  - service: cloudflare-web-analytics
    why: "Need the site token to enable the Web Analytics beacon on the website"
    env_vars:
      - name: CF_ANALYTICS_TOKEN
        source: "Cloudflare Dashboard → Analytics & Logs → Web Analytics → Add a site (or view the existing site for heartland.ankrom.ai) → copy the token from the generated beacon script snippet"
    dashboard_config:
      - task: "Enable Web Analytics for heartland.ankrom.ai"
        location: "Cloudflare Dashboard → Analytics & Logs → Web Analytics → Add a site"
        details: "Add heartland.ankrom.ai as a site. Copy the alphanumeric token from the generated <script> snippet (it appears as the value of data-cf-beacon's \"token\" field)."
    local_dev:
      - "Create .dev.vars in the project root with: CF_ANALYTICS_TOKEN=your_token_here (wrangler dev reads this file automatically)"
      - "For production: set via Cloudflare Dashboard → Workers & Pages → heartland-soccer-calendar → Settings → Variables and Secrets, or run: echo 'YOUR_TOKEN' | wrangler secret put CF_ANALYTICS_TOKEN"
---

<objective>
Add the Cloudflare Web Analytics beacon script to the landing page and subscribe page HTML.

Purpose: Enable privacy-first page-view analytics (no cookies, no third-party tracking) to understand how visitors use the site. Complements the existing server-side Cloudflare Analytics Engine used for iCal feed telemetry.
Output: Both HTML pages (`GET /` and `GET /subscribe/{teamId}`) inject the beacon script into `<head>` when `CF_ANALYTICS_TOKEN` is set in the Worker environment. When the env var is absent the pages render identically to today.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread CF_ANALYTICS_TOKEN through HTML rendering and inject beacon script into htmlHead</name>
  <files>src/index.js</files>
  <action>
    Make four targeted, minimal changes to src/index.js:

    **1. Update `htmlHead(title)` → `htmlHead(title, analyticsToken = null)`**

    Add a local variable just before the return statement:

    ```js
    const analyticsScript = analyticsToken
      ? `\n<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "${analyticsToken}"}'></script>`
      : '';
    ```

    Then append it to the template literal just before the closing `</head>` tag, so the tail of the return value becomes:

    ```
    ...
    </style>${analyticsScript}
    </head>`;
    ```

    The `defer` attribute ensures the beacon loads after page content without blocking render.

    **2. Update `renderLandingPage()` → `renderLandingPage(env)`**

    Change the `htmlHead(...)` call inside to:
    ```js
    htmlHead('Heartland Soccer Team Calendars', env?.CF_ANALYTICS_TOKEN ?? null)
    ```

    **3. Update `renderSubscribePage(teamId, url)` → `renderSubscribePage(teamId, url, env)`**

    Change its `htmlHead(...)` call inside to:
    ```js
    htmlHead('Loading… – Heartland Soccer Team Calendars', env?.CF_ANALYTICS_TOKEN ?? null)
    ```

    **4. Update callers in the main `fetch()` handler**

    - Landing page: `renderLandingPage()` → `renderLandingPage(env)`
    - Subscribe handler call: `handleSubscribePage(subscribeMatch[1], url)` → `handleSubscribePage(subscribeMatch[1], url, env)`
    - `handleSubscribePage` function signature: `(teamId, url)` → `(teamId, url, env)`
    - Inside that function body: `renderSubscribePage(teamId, url)` → `renderSubscribePage(teamId, url, env)`

    No other files change. The token is sourced from `env` (a Worker secret/env var) so it is never hardcoded in source.
  </action>
  <verify>
    Run `npm run dev` (wrangler dev) and confirm no startup errors. Then:
    - `curl http://localhost:8787/` — HTML should be valid, no template literal errors
    - `curl http://localhost:8787/subscribe/8174` — same
    - To verify the beacon script: add `CF_ANALYTICS_TOKEN=test-token` to `.dev.vars`, restart wrangler dev, and check that `curl http://localhost:8787/ | grep cloudflareinsights` returns the beacon script line
    - Without the token in .dev.vars, confirm the script is absent from the HTML
  </verify>
  <done>
    Both `/` and `/subscribe/{teamId}` render correctly with no errors.
    When CF_ANALYTICS_TOKEN is set, `<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "..."}'>` appears in `<head>`.
    When CF_ANALYTICS_TOKEN is absent, no beacon script appears.
    No regressions on the `/calendar/{teamId}` or `/api/team/{teamId}` routes.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run dev` starts without errors
- [ ] `GET /` returns valid HTML (no template literal syntax errors)
- [ ] `GET /subscribe/8174` returns valid HTML
- [ ] With CF_ANALYTICS_TOKEN set in .dev.vars, beacon script appears in `<head>` of both pages
- [ ] Without CF_ANALYTICS_TOKEN, beacon script is absent (graceful no-op)
- [ ] No changes to iCal or JSON API routes
</verification>

<success_criteria>
- Task 1 completed
- All verification checks pass
- No errors or warnings introduced
- CF_ANALYTICS_TOKEN env var pattern keeps token out of source code
- Beacon script renders correctly in both HTML pages when token is configured
</success_criteria>

<output>
After completion, create `.planning/phases/05-add-cloudflare-website-analytics-tracking-script-to-website/05-01-SUMMARY.md`
</output>
