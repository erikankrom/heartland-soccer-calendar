# Milestone v1.1: Enhancements

**Status:** ✅ SHIPPED 2026-02-20
**Phases:** 3–5
**Total Plans:** 3

## Overview

Three user-facing and infrastructure enhancements shipped after v1.0 Launch: home/away jersey color assignment in iCal events and subscribe page, field name made the clickable map link in subscribe page event rows, and Cloudflare Web Analytics beacon added to both HTML pages.

## Phases

### Phase 3: Home/Away Jersey Color Assignment

**Goal:** Update the subscribe page event rows and iCal VEVENT descriptions to show home/away jersey color assignments for each game. The home team (listed first on the schedule) wears white/light jerseys; the visiting team (listed second) wears dark jerseys.
**Depends on:** Phase 1 (field map links)
**Plans:** 1 plan

Plans:

- [x] 03-01: Add jersey color to iCal DESCRIPTION and subscribe page event rows

**Details:**

- `jerseyColor` appended to `descParts` in `generateICal()` — always present, after field map URL
- `jerseyHtml` injected into subscribe page event row HTML string in inline `<script>` block
- Home/away detection: find vsIdx via `/\bvs\.?\b/i`, slice summary up to that index, test if teamId appears in slice — more robust than start-of-string regex
- `.meta` class reused for jersey color line — no new CSS needed

---

### Phase 4: Modify Field Map Link Location

**Goal:** On the subscribe page, change the field map link so it is applied to the actual field name text rather than a separate statically-named "Map" link. The park/complex location text remains unlinked.
**Depends on:** Phase 3
**Plans:** 1 plan

Plans:

- [x] 04-01: Make field name the map link in subscribe page event rows

**Details:**

- `fieldAnchor` variable wraps `loc.field` in `<a>` when `mapUrl` exists, falls back to plain text
- `locLabel` composes `fieldAnchor` + em dash + `esc(loc.name)` — contains raw HTML (safe, all dynamic values escaped via `esc()`)
- `mapLink` retained as `var mapLink = ''` to avoid touching the `html +=` concatenation line
- Existing `a { color: var(--accent) }` global rule styles the new link automatically

---

### Phase 5: Add CloudFlare Website Analytics Tracking Script to Website

**Goal:** Add the Cloudflare Web Analytics beacon script to both HTML pages (landing and subscribe). Token sourced from `CF_ANALYTICS_TOKEN` Worker env var so it is never hardcoded in source. Gracefully absent when env var is unset.
**Depends on:** Phase 4
**Plans:** 1 plan

Plans:

- [x] 05-01: Add beacon script to htmlHead via CF_ANALYTICS_TOKEN env var

**Details:**

- `htmlHead(title, analyticsToken = null)` injects `<script defer src='https://static.cloudflareinsights.com/beacon.min.js'>` before `</head>` when token is provided
- `renderLandingPage(env)` and `renderSubscribePage(teamId, url, env)` thread `env?.CF_ANALYTICS_TOKEN ?? null` to `htmlHead()`
- Token set via `.dev.vars` locally; `wrangler secret put CF_ANALYTICS_TOKEN` in production
- Pages render identically when token is absent

---

## Milestone Summary

**Key Decisions:**

- Home/away detection uses before-vs substring check: find vsIdx via `/\bvs\.?\b/i`, slice summary up to that index, test if teamId appears in slice (handles leading brackets/codes in SUMMARY strings)
- `jerseyColor` always appended to `descParts` — every game is home or away, no unknown state
- `mapLink` retained as `''` to minimize diff — variable already referenced in `html +=` line
- `locLabel` contains raw HTML (the `<a>` tag) — safe because all dynamic values are passed through `esc()`
- `env` passed as whole object into render functions (not just the token string) — consistent with Worker env pattern, easy to extend
- `defer` attribute on analytics beacon script — never blocks page render

**Issues Resolved:**

- Initial home/away detection regex anchored to start of SUMMARY string — failed on real Heartland Soccer data where team ID is preceded by brackets or codes. Fixed with before-vs substring approach during Phase 3 human verification checkpoint.

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- None

---

_For current project status, see .planning/ROADMAP.md_
